// Comtel Voice Agent Database Schema
// Tracks calls, callback requests, messages, and agent handoffs

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User accounts - multi-tenant support
model User {
  id            String        @id @default(cuid())
  email         String        @unique
  passwordHash  String
  name          String
  companyName   String?
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relationships
  phoneNumbers  PhoneNumber[]
  sessions      Session[]
  calls         Call[]
  callbacks     Callback[]
  messages      Message[]
  agentConfig   AgentConfig?

  @@index([email])
  @@map("users")
}

// Phone numbers - map Twilio numbers to users
model PhoneNumber {
  id        String   @id @default(cuid())
  number    String   @unique // e.g., "+390220527877"
  label     String?  // e.g., "Linea Principale", "Supporto"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  // Owner
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([number])
  @@index([userId])
  @@map("phone_numbers")
}

// User sessions - for JWT token tracking and revocation
model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // User relationship
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

// Call records - tracks all incoming calls
model Call {
  id            String      @id @default(cuid())
  callSid       String      @unique // Twilio Call SID
  streamSid     String?     // Twilio Stream SID
  from          String      // Caller phone number
  to            String?     // Called number (Twilio number)
  status        String      @default("in-progress") // in-progress, completed, failed
  startedAt     DateTime    @default(now())
  endedAt       DateTime?
  duration      Int?        // Duration in seconds

  // User ownership (via phone number lookup)
  userId        String?
  user          User?       @relation(fields: [userId], references: [id])

  // Relationships
  callbacks     Callback[]
  messages      Message[]
  transcripts   Transcript[]
  analysis      CallAnalysis?

  @@index([callSid])
  @@index([startedAt])
  @@index([userId])
  @@map("calls")
}

// Callback requests - when customers ask to be called back
model Callback {
  id              String      @id @default(cuid())
  referenceNumber String      @unique // RIC-xxxxx format

  // Caller information
  callerName      String
  callerPhone     String
  preferredTime   String      // Free text: "domani mattina", "questo pomeriggio"
  reason          String?     // Why they want to be called back

  // Status tracking
  status          String      @default("pending") // pending, scheduled, completed, cancelled
  priority        String      @default("normal") // normal, high, urgent
  assignedTo      String?     // Employee assigned to make the callback

  // Timestamps
  createdAt       DateTime    @default(now())
  scheduledFor    DateTime?   // When it's scheduled
  completedAt     DateTime?   // When it was completed

  // User ownership
  userId          String?
  user            User?       @relation(fields: [userId], references: [id])

  // Related call
  callId          String?
  call            Call?       @relation(fields: [callId], references: [id])

  @@index([status])
  @@index([createdAt])
  @@index([referenceNumber])
  @@index([userId])
  @@map("callbacks")
}

// Messages - messages left for employees or departments
model Message {
  id              String      @id @default(cuid())
  referenceNumber String      @unique // MSG-xxxxx format

  // Message details
  recipientName   String      // Person or department the message is for
  callerName      String      // Who left the message
  callerPhone     String
  content         String      // The actual message
  urgent          Boolean     @default(false)

  // Status tracking
  status          String      @default("unread") // unread, read, forwarded, archived
  priority        String      @default("normal") // normal, high, urgent
  forwardedTo     String?     // Email/phone where it was forwarded

  // Timestamps
  createdAt       DateTime    @default(now())
  readAt          DateTime?   // When it was marked as read
  forwardedAt     DateTime?   // When it was forwarded

  // User ownership
  userId          String?
  user            User?       @relation(fields: [userId], references: [id])

  // Related call
  callId          String?
  call            Call?       @relation(fields: [callId], references: [id])

  @@index([status])
  @@index([recipientName])
  @@index([createdAt])
  @@index([referenceNumber])
  @@index([userId])
  @@map("messages")
}

// Transcripts - full conversation history for each call
model Transcript {
  id              String      @id @default(cuid())

  // Conversation details
  speaker         String      // user, agent, system
  agentName       String?     // Arthur, Elena (null for user/system)
  text            String      // Transcript text

  // Sequencing and timing
  sequenceNumber  Int         // Order in conversation
  timestamp       DateTime    @default(now())

  // Optional metadata
  confidence      Float?      // Transcription confidence (0.0-1.0)
  duration        Float?      // Audio duration in seconds
  eventType       String?     // conversation.item.created, transcription.completed, etc.

  // Related call
  callId          String
  call            Call        @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@index([callId, sequenceNumber])
  @@index([speaker])
  @@index([timestamp])
  @@map("transcripts")
}

// Agent Configuration - per-user agent settings
model AgentConfig {
  id                    String   @id @default(cuid())

  // Core agent settings
  agentName             String   @default("Arthur")
  voice                 String   @default("verse") // alloy, echo, shimmer, verse, coral, sage
  temperature           Float    @default(0.2)     // 0.0 - 1.0
  model                 String   @default("gpt-realtime")

  // Turn detection settings
  turnDetectionEnabled  Boolean  @default(true)
  vadThreshold          Float    @default(0.5)    // 0.0 - 1.0
  silenceDurationMs     Int      @default(500)    // milliseconds
  prefixPaddingMs       Int      @default(300)

  // Greeting configuration
  greetingMessage       String   @default("Ciao")
  greetingDelayMs       Int      @default(200)

  // Language settings
  primaryLanguage       String   @default("it")   // ISO language code
  autoDetectLanguage    Boolean  @default(true)
  transcriptionModel    String   @default("gpt-4o-transcribe")

  // User ownership (one config per user)
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relationships
  instructions          AgentInstructions?
  knowledgeBase         KnowledgeBase?
  toolConfigs           ToolConfig[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
  @@map("agent_configs")
}

// Agent Instructions - system prompt configuration
model AgentInstructions {
  id                     String   @id @default(cuid())

  // Template mode vs full text mode
  useTemplate            Boolean  @default(true)

  // Full custom instructions (when useTemplate = false)
  customInstructions     String?  @db.Text

  // Template-based section overrides (when useTemplate = true)
  roleDescription        String?  @db.Text  // Agent's role and responsibilities
  communicationStyle     String?  @db.Text  // Style guidelines
  languageInstructions   String?  @db.Text  // Multilingual handling
  closingInstructions    String?  @db.Text  // How to end calls
  additionalInstructions String?  @db.Text  // Extra custom rules

  // Relation to AgentConfig
  agentConfigId          String   @unique
  agentConfig            AgentConfig @relation(fields: [agentConfigId], references: [id], onDelete: Cascade)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("agent_instructions")
}

// Knowledge Base - company info, FAQs, etc.
model KnowledgeBase {
  id                     String   @id @default(cuid())

  // Company Information
  companyName            String?
  companyTagline         String?
  companyDescription     String?  @db.Text
  companyMission         String?  @db.Text

  // Contact Information
  phoneMain              String?
  phoneSupport           String?
  email                  String?
  website                String?

  // Location
  address                String?
  city                   String?
  postalCode             String?
  region                 String?
  country                String?  @default("Italia")
  directions             String?  @db.Text  // How to reach the office

  // Business Hours (stored as JSON)
  businessHours          Json?    // { "lunedi": "09:00-18:00", ... }
  timezone               String?  @default("CET/CEST")
  holidayNote            String?

  // Services and capabilities (stored as JSON arrays)
  services               Json?    // ["VoIP", "Networking", ...]
  businessAreas          Json?    // ["Customer & User Interaction", ...]
  partners               Json?    // ["Microsoft", "Huawei", ...]

  // FAQs (stored as JSON array)
  faqs                   Json?    // [{ "question": "...", "answer": "..." }, ...]

  // Transfer numbers
  transferNumberMain     String?
  transferNumberSupport  String?

  // Financial access (if enabled)
  financialAccessEnabled Boolean  @default(false)
  financialAccessCodes   Json?    // ["CODE1", "CODE2"]
  financialDataPath      String?  // Path to JSON file or null for embedded data

  // Relation to AgentConfig
  agentConfigId          String   @unique
  agentConfig            AgentConfig @relation(fields: [agentConfigId], references: [id], onDelete: Cascade)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("knowledge_bases")
}

// Tool Configuration - enable/disable and configure individual tools
model ToolConfig {
  id                  String   @id @default(cuid())

  toolName            String   // get_company_info, schedule_callback, etc.
  enabled             Boolean  @default(true)

  // Tool-specific parameters (stored as JSON)
  parameters          Json?    // Tool-specific config

  // Custom description override (for agent instructions)
  descriptionOverride String?

  // Relation to AgentConfig
  agentConfigId       String
  agentConfig         AgentConfig @relation(fields: [agentConfigId], references: [id], onDelete: Cascade)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([agentConfigId, toolName])
  @@index([agentConfigId])
  @@map("tool_configs")
}

// AI-powered transcript analysis results
model CallAnalysis {
  id                String   @id @default(cuid())

  // Core analysis results
  summary           String   @db.Text     // 2-3 sentence summary

  // Sentiment analysis
  sentimentOverall  String                // positive, neutral, negative, frustrated
  sentimentTrend    String?               // improving, stable, declining
  sentimentScore    Float?                // -1.0 to 1.0

  // Intent classification
  primaryIntent     String                // sales_inquiry, support, complaint, info_request, callback_request, other
  secondaryIntents  Json?                 // Array of additional intents

  // Key entities extracted (stored as JSON)
  entities          Json?                 // { names: [], products: [], dates: [], phones: [], emails: [] }

  // Action items
  actionItems       Json?                 // Array of { description: string, assignee?: string, priority?: string }

  // Scoring
  urgencyScore      String                // low, medium, high, critical
  urgencyReason     String?               // Explanation for urgency level
  leadScore         String?               // hot, warm, cold (for sales calls)
  leadScoreReason   String?               // Reasoning for lead score

  // FAQ and categorization
  isFaq             Boolean  @default(false)
  faqTopic          String?               // If FAQ, what topic
  resolutionStatus  String                // resolved, needs_followup, escalated, unknown
  topicTags         Json?                 // Array of topic tags ["VoIP", "Security", etc.]

  // Metadata
  modelUsed         String   @default("gpt-5.1")
  tokensUsed        Int?
  processingTimeMs  Int?
  language          String   @default("it")  // Detected language of transcript

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relation to Call (one-to-one)
  callId            String   @unique
  call              Call     @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@index([callId])
  @@index([primaryIntent])
  @@index([urgencyScore])
  @@index([sentimentOverall])
  @@map("call_analyses")
}
